name: CI/CD RETTA App

on:
  push:
    branches:
      - main  # ou "master", se for o nome principal do seu repositório

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Clonar repositório
        uses: actions/checkout@v3

      - name: 🐳 Subir containers com Docker Compose
        run: |
          docker compose -f docker-compose.yml up -d --build

      - name: ⏱️ Aguardar containers subirem
        run: sleep 10  # opcional, mas ajuda a evitar erro de "container not ready"

      - name: 📦 Instalar dependências do Laravel
        run: |
          docker exec jobs_RETTA composer install
          docker exec jobs_RETTA php artisan key:generate
          docker exec jobs_RETTA php artisan migrate --force

      - name: ✅ Verificar serviços
        run: docker ps

      - name: 🧪 Testar aplicação Laravel
        run: docker exec jobs_RETTA php artisan test

      - name: 🚀 Finalizar deploy
        run: echo "✅ Deploy concluído com sucesso!"
